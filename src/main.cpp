#include <iostream>
#include <string_view>

#include <boost/algorithm/hex.hpp>
#include <boost/exception/diagnostic_information.hpp>

#include <nlohmann/json.hpp>

#include <serialize.h>
#include <serialize_io.h>
#include <json_types_io.h>


using namespace std::string_literals;


static const auto cbor =
     "835860a563616c676a474f5354333431303132637362747263727970746f5f636f6e73656e"
     "745f726571637479706343575463766572016978357423537432353658201e0e64b7e2210e"
     "34f19293328e3ce191180e39a37e25a9b9f23a724d91f725535901b0ad6361756481666d70"
     "6175746869636c69656e745f69646579612e72756b636c69656e745f6e616d6567636c6965"
     "6e74316d636c69656e745f6f67726e69706d31313332303734353037333535636374695820"
     "911e36fa217419310b0329b04b830a06af76d103a5e9a3223ed24dba92472887636578701a"
     "66fbe6a9636961741a66fbe57d636973737818687474703a2f2f657369612e676f7375736c"
     "7567692e7275756f627461696e65645f636f6e73656e745f6c697374a16866756c6c6e616d"
     "6573d0bfd0bed0bbd0bdd0bed0b520d0b8d0bcd18f677265715f6374695820c5dcb61df15d"
     "70cc17fb6e74f5bcf6710d1ac376d03d9b77c4973f92ba1472c7767265717565737465645f"
     "636f6e73656e745f6c697374a1696269727468646174657819d094d0b0d182d0b020d180d0"
     "bed0b6d0b4d0b5d0bdd0b8d18f687265736f75726365a167736572766572316c7365727665"
     "7231206e616d656e75726e3a657369613a7472757374a1781f75726e3a657369613a747275"
     "73743a63727970746f5f617574685f72657370582021cbb4569de6092fd6ad3968b08f65a0"
     "7798afb8865a5d783e81e4c3a133f70b5840b26fe713f164944f0f5a9e8d8ea99f94a69fc0"
     "f6554f59d56b72f492b97f76c262bdc5f8c627ee9baaf687cc129cc914448b2f3720a02659"
     "16d5ede8efdded21"s;

static const auto cborResp =
     "835902a7a5637479706343575463616c676a474f53543334313031326378356359026b3082"
     "026730820212a00302010202011e300c06082a8503070101030205003081d0310b30090603"
     "550406130252553115301306035504080c0cd09cd0bed181d0bad0b2d0b031153013060355"
     "04070c0cd09cd0bed181d0bad0b2d0b0311b3019060355040a0c12d090d09e20d0a0d0a220"
     "d09bd0b0d0b1d1813111300f060355040b0c08d095d0a1d098d0903135303306035504030c"
     "2cd0a2d0b5d181d182d0bed0b2d18bd0b920d0a3d0a620d095d0a1d098d09020d093d09ed0"
     "a1d0a22032303132312c302a06092a864886f70d010901161d6d696b6861696c2e616c656b"
     "73616e64726f764072746c6162732e7275301e170d3234303731353135343835385a170d32"
     "37303431313135343835385a3043310b30090603550406130252553134303206035504030c"
     "2b4944483631416f43795069666a3461625a353155703065574870754a6b43556d48576753"
     "54786f493362413066301f06082a85030701010101301306072a85030202230106082a8503"
     "07010102020343000440ad9121a0a5271c20881a7f4da15c5a735dfc67995438448d7d1c84"
     "d6ba1cb02cec6a3da6b740975a436446eebe42f8a6275b317438f507fcebb9df9d725a8509"
     "a35a3058301f0603551d23041830168014f088280f33fc4d3a1e4be972a821af95bd05d91a"
     "30090603551d1304023000300b0603551d0f0404030203f8301d0603551d25041630140608"
     "2b0601050507030206082b06010505070304300c06082a8503070101030205000341003a47"
     "59cbfd47b474e8f2846ceca35c023841407969672f47779249fe031708f005e1173651b660"
     "1a7e34252e38ef9c66f29ca14c1ea7bd0102859346c474646a637665720163736274736372"
     "7970746f5f636f6e73656e745f72657370590151ab63637469582024a8e0678460f26c5a11"
     "b9e1f9226180f55f13a4b8eba9ee9b0ebb91ee7b601c677265715f637469582002811677a7"
     "21166b6f7028da0af1d186b23676c96a20fd7714c67b721aa58c35636973736d706572736f"
     "6e2e69642e6170706361756469706572736f6e2e6964636961741a66fd3142636578701a66"
     "fd326e6373756258202031fad40a02c8f89f8f869b679d54a747961e9b899025261d68124f"
     "1a08ddb069636c69656e745f6964746d6167617a696e2e6e61646976616e652e636f6d6872"
     "65736f7572636581677365727665723176726573706f6e7365645f636f6e73656e745f6c69"
     "737481696269727468646174656e75726e3a657369613a7472757374a1782175726e3a6573"
     "69613a74727573743a63727970746f5f636f6e73656e745f72657158202e98cb43924c951b"
     "dac303e62c6333ed21cab5cea1f20928e771dc69f59ce69858400d1f7c09e95df0f5658103"
     "87e56f853a2ea857a9ba3c24339547319959316315ae6e6a65f0536c8200044d8b1b2c832a"
     "be1c0276c9ed9cb74c7c03ddc4f2e005"s;


int main()
{
     try
     {
          const auto cborBin = boost::algorithm::unhex( cbor );
          const auto cwt = Cwt::getParsed({ cborBin.cbegin(), cborBin.cend() });

          std::cout << std::setw( 2 ) << Header::getParsed( cwt.header ) << '\n';
          std::cout << std::setw( 2 ) << RequestPayload::getParsed( cwt.payload ) << '\n';
          std::cout << "Signature:\n  " << cwt.signature << '\n';
     }
     catch( ... )
     {
          std::cerr << "exception: " << boost::current_exception_diagnostic_information() << '\n';
     }

     return 0;
}
